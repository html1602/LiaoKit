# LiaoKit ä¼šè¯çŠ¶æ€ç®¡ç†å®Œæ•´ä½¿ç”¨è¯´æ˜

![ç‰ˆæœ¬](https://img.shields.io/badge/ç‰ˆæœ¬-2.7.5-blue.svg)
![æœ€åæ›´æ–°](https://img.shields.io/badge/æœ€åæ›´æ–°-2025--06--25-green.svg)

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

LiaoKit ä¼šè¯çŠ¶æ€ç®¡ç†æ˜¯ä¸€ä¸ªå…¨å±€çŠ¶æ€æ§åˆ¶ç³»ç»Ÿï¼Œä¸“ä¸ºæ™ºèƒ½å®¢æœã€AI å¯¹è¯å’Œå¤šæµç¨‹å¡ç‰‡é©±åŠ¨ç­‰åœºæ™¯è®¾è®¡ã€‚å®ƒæä¾›äº†å®Œæ•´çš„ä¼šè¯çŠ¶æ€ç®¡ç†ã€è¾“å…¥é”å®šæ§åˆ¶å’Œæ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†èƒ½åŠ›ã€‚

### æ ¸å¿ƒç‰¹æ€§

- ğŸ”’ **æ™ºèƒ½é”å®šæ§åˆ¶** - è‡ªåŠ¨ç®¡ç†è¾“å…¥é”å®šçŠ¶æ€ï¼Œé˜²æ­¢ç”¨æˆ·åœ¨ä¸å½“æ—¶æœºè¾“å…¥
- ğŸ¤– **ä¼šè¯æ¨¡å¼åˆ‡æ¢** - æ”¯æŒ AI æ¨¡å¼å’Œäººå·¥æ¨¡å¼çš„æ— ç¼åˆ‡æ¢
- ğŸ”Œ **æ’ä»¶ç”Ÿå‘½å‘¨æœŸ** - å®Œæ•´çš„æ’ä»¶çŠ¶æ€ç®¡ç†å’Œå¿…é¡»å®Œæˆæ§åˆ¶
- â° **è‡ªåŠ¨è§£é”æœºåˆ¶** - é˜²æ­¢æ°¸ä¹…é”å®šçš„å®‰å…¨ä¿æŠ¤æœºåˆ¶
- ğŸ“Š **å®æ—¶çŠ¶æ€ç›‘æ§** - æä¾›è¯¦ç»†çš„çŠ¶æ€å˜åŒ–äº‹ä»¶å’Œæ—¥å¿—
- ğŸ”§ **é«˜åº¦å¯é…ç½®** - æ”¯æŒç»†ç²’åº¦çš„çŠ¶æ€æ§åˆ¶å’Œè‡ªå®šä¹‰é…ç½®

## ğŸ“¦ æ¶æ„è®¾è®¡

### ç»„ä»¶å±‚çº§æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                LiaoWindow                   â”‚
â”‚         (å…¨å±€çŠ¶æ€ç®¡ç†å™¨)                     â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚          å­ç»„ä»¶çŠ¶æ€æ³¨å…¥                  â”‚â”‚
â”‚  â”‚    (é€šè¿‡provide/injectæœºåˆ¶)              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  LiaoInputArea   â”‚ â”‚  LiaoPluginBubble   â”‚â”‚
â”‚  â”‚   (çŠ¶æ€å“åº”è€…)    â”‚ â”‚   (çŠ¶æ€è§¦å‘è€…)       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€ç®¡ç†æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·æ“ä½œ] --> B{åˆ¤æ–­æ“ä½œç±»å‹}
    B -->|å‘é€æ¶ˆæ¯| C[æ£€æŸ¥ä¼šè¯æ¨¡å¼]
    B -->|æ’ä»¶æ“ä½œ| D[æ£€æŸ¥æ’ä»¶ç±»å‹]
    C -->|AIæ¨¡å¼| E[é”å®šè¾“å…¥ - AI_REPLYING]
    C -->|äººå·¥æ¨¡å¼| F[æ­£å¸¸å¤„ç†]
    D -->|å¿…é¡»å®Œæˆ| G[é”å®šè¾“å…¥ - PLUGIN_PENDING]
    D -->|å¯é€‰å®Œæˆ| H[ä¸é”å®šè¾“å…¥]
    E --> I[ç­‰å¾…AIå›å¤]
    G --> J[ç­‰å¾…æ’ä»¶å®Œæˆ]
    I --> K[è‡ªåŠ¨è§£é”]
    J --> L{æ’ä»¶ç»“æœ}
    L -->|å®Œæˆ| K
    L -->|å–æ¶ˆ/é”™è¯¯| M{æ˜¯å¦å¿…é¡»}
    M -->|æ˜¯| N[ä¿æŒé”å®š]
    M -->|å¦| K
    K --> O[è¾“å…¥å¯ç”¨]
    N --> P[ç­‰å¾…é‡æ–°æ“ä½œ]
```

## ğŸ”§ æ ¸å¿ƒAPI

### ä¼šè¯çŠ¶æ€ç±»å‹

```typescript
// ä¼šè¯æ¨¡å¼ç±»å‹
export type SessionMode = 'AI' | 'human';

// é”å®šåŸå› ç±»å‹
export type LockReason = 
  | 'AI_REPLYING'      // AIæ­£åœ¨å›å¤ä¸­
  | 'PLUGIN_PENDING'   // æ’ä»¶æ“ä½œå¾…å®Œæˆ  
  | 'FORM_REQUIRED'    // è¡¨å•å¡«å†™å¿…é¡»å®Œæˆ
  | 'VOTE_REQUIRED'    // æŠ•ç¥¨é€‰æ‹©å¿…é¡»å®Œæˆ
  | 'CUSTOM'           // è‡ªå®šä¹‰é”å®šåŸå› 
  | null;

// æ´»è·ƒæ’ä»¶ä¿¡æ¯
export interface ActivePlugin {
  id: string | number;     // æ’ä»¶å”¯ä¸€æ ‡è¯†
  type: string;           // æ’ä»¶ç±»å‹
  messageId?: string | number;  // å…³è”çš„æ¶ˆæ¯ID
  required?: boolean;     // æ˜¯å¦å¿…é¡»å®Œæˆ
  data?: any;            // æ’ä»¶æ•°æ®
}

// å…¨å±€çŠ¶æ€ç®¡ç†æ¥å£
export interface LiaoSessionState {
  sessionMode: SessionMode;           // å½“å‰ä¼šè¯æ¨¡å¼
  isInputLocked: boolean;            // è¾“å…¥æ˜¯å¦è¢«é”å®š
  activePlugin: ActivePlugin | null; // å½“å‰æ´»è·ƒæ’ä»¶
  lockReason: LockReason;            // é”å®šåŸå› 
  lockInput: (reason: LockReason, plugin?: ActivePlugin) => void;
  unlockInput: () => void;
  emergencyUnlock: () => void;
}
```

### é”å®šåŸå› ä¼˜å…ˆçº§

```typescript
const lockReasonPriority = {
  'AI_REPLYING': 1,        // æœ€é«˜ä¼˜å…ˆçº§
  'PLUGIN_PENDING': 2,
  'FORM_REQUIRED': 3,
  'VOTE_REQUIRED': 4,
  'CUSTOM': 5              // æœ€ä½ä¼˜å…ˆçº§
};
```

**è¯´æ˜**: é«˜ä¼˜å…ˆçº§çš„é”å®šå¯ä»¥è¦†ç›–ä½ä¼˜å…ˆçº§çš„é”å®šçŠ¶æ€ã€‚

## ğŸ—ï¸ åŸºç¡€ä½¿ç”¨

### 1. åŸºç¡€çª—å£é…ç½®

```vue
<template>
  <LiaoWindow
    :default-session-mode="'human'"
    :auto-unlock-timeout="30000"
    :enable-emergency-unlock="true"
    @session-mode-change="handleSessionModeChange"
    @input-lock-change="handleLockChange"
    @plugin-complete="handlePluginComplete"
    @plugin-cancel="handlePluginCancel"
    @plugin-error="handlePluginError"
    @emergency-unlock="handleEmergencyUnlock"
  >
    <LiaoMessageList 
      :messages="messages"
      @plugin-complete="handlePluginComplete"
    />
    <LiaoInputArea 
      v-model="inputText"
      @send="handleSendMessage"
    />
  </LiaoWindow>
</template>

<script setup>
import { ref } from 'vue'
import { LiaoWindow, LiaoMessageList, LiaoInputArea } from '@yuandezuohua/liaokit'

const inputText = ref('')
const messages = ref([])

// å¤„ç†ä¼šè¯æ¨¡å¼å˜åŒ–
const handleSessionModeChange = ({ oldMode, newMode }) => {
  console.log(`ä¼šè¯æ¨¡å¼ä» ${oldMode} åˆ‡æ¢åˆ° ${newMode}`)
}

// å¤„ç†é”å®šçŠ¶æ€å˜åŒ–
const handleLockChange = ({ locked, reason, plugin }) => {
  if (locked) {
    console.log(`è¾“å…¥å·²é”å®š: ${reason}`)
  } else {
    console.log('è¾“å…¥å·²è§£é”')
  }
}

// å¤„ç†æ¶ˆæ¯å‘é€
const handleSendMessage = (message) => {
  messages.value.push({
    id: Date.now(),
    type: 'text',
    content: message,
    isSelf: true,
    time: new Date(),
    status: 'sent'
  })
  inputText.value = ''
}
</script>
```

### 2. æ’ä»¶å¿…é¡»å®Œæˆæ§åˆ¶

```vue
<template>
  <LiaoWindow>
    <LiaoMessageList :messages="messagesWithPlugin" />
    <LiaoInputArea />
  </LiaoWindow>
</template>

<script setup>
const messagesWithPlugin = ref([
  {
    id: 1,
    type: 'text',
    content: 'è¯·å®Œæˆä»¥ä¸‹è¡¨å•å¡«å†™ï¼š',
    isSelf: false,
    time: new Date(),
    status: 'sent'
  },
  {
    id: 2,
    type: 'plugin',
    pluginType: 'form',
    pluginRequired: true,  // å¿…é¡»å®Œæˆï¼Œä¼šé”å®šè¾“å…¥
    pluginData: {
      fields: [
        { name: 'name', label: 'å§“å', type: 'text', required: true },
        { name: 'email', label: 'é‚®ç®±', type: 'email', required: true }
      ]
    },
    isSelf: false,
    time: new Date(),
    status: 'sent'
  },
  {
    id: 3,
    type: 'plugin', 
    pluginType: 'info',
    pluginRequired: false, // éå¿…é¡»ï¼Œä¸ä¼šé”å®šè¾“å…¥
    pluginData: {
      title: 'æ¸©é¦¨æç¤º',
      content: 'è¿™æ˜¯ä¸€ä¸ªä¿¡æ¯å±•ç¤ºæ’ä»¶'
    },
    isSelf: false,
    time: new Date(),
    status: 'sent'
  }
])
</script>
```

## ğŸ›ï¸ é«˜çº§é…ç½®

### 1. çŠ¶æ€ç®¡ç†å™¨æ¨¡å¼

```vue
<template>
  <LiaoWindow
    ref="windowRef"
    :default-session-mode="sessionMode"
    :auto-unlock-timeout="autoUnlockTime"
    @input-lock-change="handleLockChange"
  >
    <template #default="{ 
      sessionMode: currentMode,
      isInputLocked,
      activePlugin,
      lockReason,
      onLockInput,
      onUnlockInput,
      onEmergencyUnlock
    }">
      <div class="chat-container">
        <!-- çŠ¶æ€æ˜¾ç¤ºé¢æ¿ -->
        <div class="status-panel">
          <div class="status-item">
            <label>ä¼šè¯æ¨¡å¼ï¼š</label>
            <span :class="'mode-' + currentMode">
              {{ currentMode === 'AI' ? 'ğŸ¤– AIæ¨¡å¼' : 'ğŸ‘¥ äººå·¥æ¨¡å¼' }}
            </span>
          </div>
          <div class="status-item">
            <label>è¾“å…¥çŠ¶æ€ï¼š</label>
            <span :class="{ locked: isInputLocked }">
              {{ isInputLocked ? 'ğŸ”’ å·²é”å®š' : 'ğŸ”“ å¯è¾“å…¥' }}
            </span>
          </div>
          <div class="status-item">
            <label>é”å®šåŸå› ï¼š</label>
            <span>{{ lockReason ? getLockReasonText(lockReason) : 'æ— ' }}</span>
          </div>
        </div>

        <!-- èŠå¤©åŒºåŸŸ -->
        <LiaoMessageList :messages="messages" />
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
          <button @click="() => onLockInput('AI_REPLYING')">
            æ¨¡æ‹ŸAIå›å¤é”å®š
          </button>
          <button @click="() => onLockInput('CUSTOM')">
            è‡ªå®šä¹‰é”å®š
          </button>
          <button @click="onUnlockInput">
            æ‰‹åŠ¨è§£é”
          </button>
          <button @click="onEmergencyUnlock">
            ç´§æ€¥è§£é”
          </button>
        </div>

        <LiaoInputArea />
      </div>
    </template>
  </LiaoWindow>
</template>

<script setup>
import { ref, computed } from 'vue'

const windowRef = ref()
const sessionMode = ref('human')
const autoUnlockTime = ref(30000)

// æ ¹æ®æ¨¡å¼åŠ¨æ€è°ƒæ•´è¶…æ—¶æ—¶é—´
const adjustedTimeout = computed(() => {
  return sessionMode.value === 'AI' ? 15000 : 60000
})

// é”å®šåŸå› æ–‡æœ¬æ˜ å°„
const getLockReasonText = (reason) => {
  const reasonMap = {
    'AI_REPLYING': 'AIæ­£åœ¨å›å¤ä¸­',
    'PLUGIN_PENDING': 'æ’ä»¶æ“ä½œå¾…å®Œæˆ',
    'FORM_REQUIRED': 'è¡¨å•å¡«å†™å¿…é¡»å®Œæˆ',
    'VOTE_REQUIRED': 'æŠ•ç¥¨é€‰æ‹©å¿…é¡»å®Œæˆ',
    'CUSTOM': 'è‡ªå®šä¹‰é”å®š'
  }
  return reasonMap[reason] || 'æœªçŸ¥åŸå› '
}

// åŠ¨æ€åˆ‡æ¢æ¨¡å¼
const switchToAI = () => {
  windowRef.value.setSessionMode('AI')
}

const switchToHuman = () => {
  windowRef.value.setSessionMode('human')
}
</script>
```

### 2. AI å¯¹è¯æµç¨‹æ§åˆ¶

```vue
<template>
  <LiaoWindow
    ref="windowRef"
    :default-session-mode="'AI'"
    @input-lock-change="handleLockChange"
  >
    <LiaoMessageList :messages="messages" />
    <LiaoInputArea @send="handleAIChat" />
  </LiaoWindow>
</template>

<script setup>
import { ref } from 'vue'

const windowRef = ref()
const messages = ref([])
const isAIThinking = ref(false)

const handleAIChat = async (userMessage) => {
  // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
  messages.value.push({
    id: Date.now(),
    type: 'text',
    content: userMessage,
    isSelf: true,
    time: new Date(),
    status: 'sent'
  })

  // é”å®šè¾“å…¥ï¼Œæ˜¾ç¤ºAIæ€è€ƒçŠ¶æ€
  windowRef.value.lockInput('AI_REPLYING')
  isAIThinking.value = true

  try {
    // æ¨¡æ‹ŸAIæ€è€ƒè¿‡ç¨‹
    await simulateAIThinking()
    
    // è°ƒç”¨AI APIè·å–å›å¤
    const aiResponse = await callAIAPI(userMessage)
    
    // æ·»åŠ AIå›å¤
    messages.value.push({
      id: Date.now(),
      type: 'text',
      content: aiResponse,
      isSelf: false,
      name: 'AIåŠ©æ‰‹',
      avatar: 'ğŸ¤–',
      time: new Date(),
      status: 'sent'
    })

  } catch (error) {
    console.error('AIå›å¤å¤±è´¥:', error)
    
    // æ·»åŠ é”™è¯¯æç¤º
    messages.value.push({
      id: Date.now(),
      type: 'text',
      content: 'æŠ±æ­‰ï¼ŒAIæš‚æ—¶æ— æ³•å›å¤ï¼Œè¯·ç¨åé‡è¯•ã€‚',
      isSelf: false,
      name: 'AIåŠ©æ‰‹',
      avatar: 'ğŸ¤–',
      time: new Date(),
      status: 'sent'
    })
  } finally {
    // è§£é”è¾“å…¥
    windowRef.value.unlockInput()
    isAIThinking.value = false
  }
}

const simulateAIThinking = () => {
  return new Promise(resolve => {
    // æ¨¡æ‹ŸAIæ€è€ƒæ—¶é—´
    setTimeout(resolve, 2000)
  })
}

const callAIAPI = async (message) => {
  // è¿™é‡Œè°ƒç”¨å®é™…çš„AI API
  // è¿”å›æ¨¡æ‹Ÿå›å¤
  return `æˆ‘ç†è§£æ‚¨çš„é—®é¢˜ï¼š"${message}"ï¼Œè¿™æ˜¯æˆ‘çš„å›å¤...`
}
</script>
```

### 3. å¤æ‚æ’ä»¶æµç¨‹æ§åˆ¶

```vue
<template>
  <LiaoWindow
    ref="windowRef"
    @plugin-complete="handlePluginComplete"
    @plugin-cancel="handlePluginCancel" 
    @plugin-error="handlePluginError"
  >
    <LiaoMessageList :messages="complexMessages" />
    <LiaoInputArea />
  </LiaoWindow>
</template>

<script setup>
import { ref } from 'vue'

const windowRef = ref()

const complexMessages = ref([
  {
    id: 1,
    type: 'text',
    content: 'æ¬¢è¿ä½¿ç”¨æ™ºèƒ½å®¢æœç³»ç»Ÿï¼',
    isSelf: false,
    time: new Date(),
    status: 'sent'
  },
  {
    id: 2,
    type: 'plugin',
    pluginType: 'vote',
    pluginRequired: true, // å¿…é¡»å®ŒæˆæŠ•ç¥¨
    pluginData: {
      title: 'è¯·é€‰æ‹©æ‚¨çš„é—®é¢˜ç±»å‹',
      options: [
        { id: 1, text: 'è´¦æˆ·é—®é¢˜', value: 'account' },
        { id: 2, text: 'æŠ€æœ¯æ”¯æŒ', value: 'tech' },
        { id: 3, text: 'äº§å“å’¨è¯¢', value: 'product' }
      ],
      allowMultiple: false
    },
    isSelf: false,
    time: new Date(),
    status: 'sent'
  },
  {
    id: 3,
    type: 'plugin',
    pluginType: 'form',
    pluginRequired: false, // å¯é€‰å¡«å†™
    pluginData: {
      title: 'è¯¦ç»†ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰',
      fields: [
        { name: 'phone', label: 'è”ç³»ç”µè¯', type: 'tel' },
        { name: 'description', label: 'é—®é¢˜æè¿°', type: 'textarea' }
      ]
    },
    isSelf: false,
    time: new Date(),
    status: 'sent'
  }
])

// å¤„ç†æ’ä»¶å®Œæˆ
const handlePluginComplete = (data) => {
  console.log('æ’ä»¶å®Œæˆ:', data)
  
  if (data.pluginType === 'vote') {
    // æŠ•ç¥¨å®Œæˆåï¼Œæ ¹æ®é€‰æ‹©å±•ç¤ºä¸åŒå†…å®¹
    const selectedOption = data.result.selectedOptions[0]
    
    messages.value.push({
      id: Date.now(),
      type: 'text',
      content: `æ‚¨é€‰æ‹©äº†"${selectedOption.text}"ï¼Œæˆ‘å°†ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„${selectedOption.text}æœåŠ¡ã€‚`,
      isSelf: false,
      time: new Date(),
      status: 'sent'
    })
  }
  
  // è‡ªåŠ¨è§£é”è¾“å…¥ï¼ˆç”±ç³»ç»Ÿå¤„ç†ï¼‰
}

// å¤„ç†æ’ä»¶å–æ¶ˆ
const handlePluginCancel = (data) => {
  console.log('æ’ä»¶å–æ¶ˆ:', data)
  
  if (data.pluginRequired) {
    // å¿…é¡»å®Œæˆçš„æ’ä»¶è¢«å–æ¶ˆï¼Œæç¤ºç”¨æˆ·
    messages.value.push({
      id: Date.now(),
      type: 'text',
      content: 'è¯¥æ“ä½œæ˜¯å¿…é¡»å®Œæˆçš„ï¼Œè¯·é‡æ–°é€‰æ‹©ã€‚',
      isSelf: false,
      time: new Date(),
      status: 'sent'
    })
    // ä¿æŒé”å®šçŠ¶æ€
  } else {
    // å¯é€‰æ’ä»¶å–æ¶ˆï¼Œç»§ç»­æµç¨‹
    messages.value.push({
      id: Date.now(),
      type: 'text',
      content: 'å·²è·³è¿‡å¯é€‰æ“ä½œï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ',
      isSelf: false,
      time: new Date(),
      status: 'sent'
    })
  }
}

// å¤„ç†æ’ä»¶é”™è¯¯
const handlePluginError = (data) => {
  console.error('æ’ä»¶é”™è¯¯:', data)
  
  messages.value.push({
    id: Date.now(),
    type: 'text',
    content: 'æ“ä½œå‡ºç°å¼‚å¸¸ï¼Œè¯·é‡è¯•æˆ–è”ç³»å®¢æœã€‚',
    isSelf: false,
    time: new Date(),
    status: 'sent'
  })
  
  // æ ¹æ®æ˜¯å¦å¿…é¡»å®Œæˆå†³å®šæ˜¯å¦è§£é”
  if (!data.pluginRequired) {
    windowRef.value.unlockInput()
  }
}
</script>
```

## ğŸ”§ çŠ¶æ€æ§åˆ¶æ–¹æ³•

### æ‰‹åŠ¨çŠ¶æ€æ§åˆ¶

```typescript
// è·å–çª—å£ç»„ä»¶å¼•ç”¨
const windowRef = ref<InstanceType<typeof LiaoWindow>>()

// æ‰‹åŠ¨é”å®šè¾“å…¥
const lockInput = (reason: LockReason, plugin?: ActivePlugin) => {
  windowRef.value?.lockInput(reason, plugin)
}

// æ‰‹åŠ¨è§£é”è¾“å…¥
const unlockInput = () => {
  windowRef.value?.unlockInput()
}

// ç´§æ€¥è§£é”ï¼ˆæ— æ¡ä»¶è§£é”ï¼‰
const emergencyUnlock = () => {
  windowRef.value?.emergencyUnlock()
}

// åˆ‡æ¢ä¼šè¯æ¨¡å¼
const setSessionMode = (mode: SessionMode) => {
  windowRef.value?.setSessionMode(mode)
}
```

### çŠ¶æ€ç›‘å¬

```vue
<template>
  <LiaoWindow
    @session-mode-change="onSessionModeChange"
    @input-lock-change="onInputLockChange"
    @plugin-complete="onPluginComplete"
    @plugin-cancel="onPluginCancel"
    @plugin-error="onPluginError"
    @emergency-unlock="onEmergencyUnlock"
  >
    <!-- å†…å®¹ -->
  </LiaoWindow>
</template>

<script setup>
// ä¼šè¯æ¨¡å¼å˜åŒ–ç›‘å¬
const onSessionModeChange = ({ oldMode, newMode }) => {
  console.log(`ä¼šè¯æ¨¡å¼ä» ${oldMode} åˆ‡æ¢åˆ° ${newMode}`)
  
  // æ ¹æ®æ¨¡å¼è°ƒæ•´ç•Œé¢
  if (newMode === 'AI') {
    // AIæ¨¡å¼çš„ç‰¹æ®Šå¤„ç†
    setupAIMode()
  } else {
    // äººå·¥æ¨¡å¼çš„ç‰¹æ®Šå¤„ç†
    setupHumanMode()
  }
}

// è¾“å…¥é”å®šçŠ¶æ€å˜åŒ–ç›‘å¬
const onInputLockChange = ({ locked, reason, plugin }) => {
  console.log('é”å®šçŠ¶æ€å˜åŒ–:', { locked, reason, plugin })
  
  if (locked) {
    // æ˜¾ç¤ºé”å®šçŠ¶æ€æŒ‡ç¤ºå™¨
    showLockIndicator(reason)
  } else {
    // éšè—é”å®šçŠ¶æ€æŒ‡ç¤ºå™¨
    hideLockIndicator()
  }
}

// æ’ä»¶å®Œæˆç›‘å¬
const onPluginComplete = (data) => {
  console.log('æ’ä»¶å®Œæˆ:', data)
  
  // è®°å½•ç”¨æˆ·æ“ä½œ
  logUserAction('plugin_complete', data)
  
  // å¯èƒ½çš„åç»­å¤„ç†
  handlePluginResult(data)
}

// æ’ä»¶å–æ¶ˆç›‘å¬
const onPluginCancel = (data) => {
  console.log('æ’ä»¶å–æ¶ˆ:', data)
  
  // è®°å½•ç”¨æˆ·æ“ä½œ
  logUserAction('plugin_cancel', data)
  
  // å¤„ç†å–æ¶ˆé€»è¾‘
  handlePluginCancel(data)
}

// æ’ä»¶é”™è¯¯ç›‘å¬
const onPluginError = (data) => {
  console.error('æ’ä»¶é”™è¯¯:', data)
  
  // è®°å½•é”™è¯¯ä¿¡æ¯
  logError('plugin_error', data)
  
  // é”™è¯¯æ¢å¤å¤„ç†
  handlePluginError(data)
}

// ç´§æ€¥è§£é”ç›‘å¬
const onEmergencyUnlock = () => {
  console.warn('è§¦å‘ç´§æ€¥è§£é”')
  
  // è®°å½•ç´§æ€¥è§£é”äº‹ä»¶
  logEmergencyEvent('emergency_unlock')
  
  // å¯èƒ½çš„æ¸…ç†æ“ä½œ
  cleanupLockedState()
}
</script>
```

## â° è‡ªåŠ¨è§£é”æœºåˆ¶

### åŸºç¡€è‡ªåŠ¨è§£é”

```vue
<template>
  <LiaoWindow
    :auto-unlock-timeout="30000"  <!-- 30ç§’è‡ªåŠ¨è§£é” -->
    :enable-emergency-unlock="true"
    @emergency-unlock="handleTimeout"
  >
    <!-- å†…å®¹ -->
  </LiaoWindow>
</template>

<script setup>
const handleTimeout = () => {
  console.log('è‡ªåŠ¨è§£é”è§¦å‘')
  
  // å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›æ¸…ç†å·¥ä½œ
  cleanupState()
  
  // é€šçŸ¥ç”¨æˆ·
  showNotification('ç”±äºé•¿æ—¶é—´æ— æ“ä½œï¼Œå·²è‡ªåŠ¨è§£é”è¾“å…¥')
}
</script>
```

### æ™ºèƒ½è‡ªåŠ¨è§£é”

```vue
<template>
  <LiaoWindow
    ref="windowRef"
    :auto-unlock-timeout="dynamicTimeout"
    @input-lock-change="handleLockChange"
  >
    <!-- å†…å®¹ -->
  </LiaoWindow>
</template>

<script setup>
import { ref, computed } from 'vue'

const windowRef = ref()
const currentLockReason = ref(null)
const sessionMode = ref('human')

// æ ¹æ®é”å®šåŸå› åŠ¨æ€è°ƒæ•´è¶…æ—¶æ—¶é—´
const dynamicTimeout = computed(() => {
  switch (currentLockReason.value) {
    case 'AI_REPLYING':
      return 15000  // AIå›å¤æœ€å¤šç­‰å¾…15ç§’
    case 'FORM_REQUIRED':
      return 300000 // è¡¨å•å¡«å†™æœ€å¤šç­‰å¾…5åˆ†é’Ÿ
    case 'VOTE_REQUIRED':
      return 60000  // æŠ•ç¥¨é€‰æ‹©æœ€å¤šç­‰å¾…1åˆ†é’Ÿ
    case 'PLUGIN_PENDING':
      return 120000 // æ’ä»¶æ“ä½œæœ€å¤šç­‰å¾…2åˆ†é’Ÿ
    default:
      return 30000  // é»˜è®¤30ç§’
  }
})

const handleLockChange = ({ locked, reason }) => {
  currentLockReason.value = reason
  
  if (locked) {
    console.log(`é”å®šè¾“å…¥ï¼Œé¢„è®¡${dynamicTimeout.value / 1000}ç§’åè‡ªåŠ¨è§£é”`)
  }
}
</script>
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ

```typescript
// âœ… æ¨èï¼šå•ä¸€çŠ¶æ€æº
const sessionState = provide(LIAO_SESSION_STATE_KEY, {
  sessionMode,
  isInputLocked,
  activePlugin,
  lockReason,
  lockInput,
  unlockInput,
  emergencyUnlock
})

// âŒ é¿å…ï¼šå¤šä¸ªçŠ¶æ€æº
const localLocked = ref(false)
const globalLocked = inject(LIAO_SESSION_STATE_KEY)
```

```typescript
// âœ… æ¨èï¼šæ˜ç¡®çš„çŠ¶æ€æ›´æ–°
const lockInput = (reason: LockReason, plugin?: ActivePlugin) => {
  // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
  clearAutoUnlockTimer()
  
  // æ›´æ–°çŠ¶æ€
  isInputLocked.value = true
  lockReason.value = reason
  activePlugin.value = plugin
  
  // è®¾ç½®æ–°çš„å®šæ—¶å™¨
  setAutoUnlockTimer()
  
  // é€šçŸ¥çŠ¶æ€å˜åŒ–
  emit('input-lock-change', { locked: true, reason, plugin })
}

// âŒ é¿å…ï¼šç›´æ¥ä¿®æ”¹çŠ¶æ€
isInputLocked.value = true // æ²¡æœ‰å¤„ç†å‰¯ä½œç”¨
```

### 2. æ’ä»¶è®¾è®¡æœ€ä½³å®è·µ

```vue
<!-- âœ… æ¨èï¼šæ˜ç¡®çš„å¿…é¡»å®Œæˆæ ‡è¯† -->
<template>
  <div v-for="message in messages" :key="message.id">
    <LiaoPluginBubble
      v-if="message.type === 'plugin'"
      :plugin-type="message.pluginType"
      :plugin-data="message.pluginData"
      :plugin-required="message.pluginRequired ?? false"
      @complete="handlePluginComplete"
      @cancel="handlePluginCancel"
      @error="handlePluginError"
    />
  </div>
</template>

<!-- âŒ é¿å…ï¼šä¸æ˜ç¡®çš„çŠ¶æ€æ§åˆ¶ -->
<template>
  <LiaoPluginBubble
    :plugin-type="message.pluginType"
    :should-lock="someBusinessLogic(message)" <!-- ä¸šåŠ¡é€»è¾‘æ··å…¥ç»„ä»¶ -->
  />
</template>
```

### 3. é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

```typescript
// âœ… æ¨èï¼šå®Œæ•´çš„é”™è¯¯å¤„ç†
const handlePluginError = async (data) => {
  try {
    // è®°å½•é”™è¯¯
    logger.error('æ’ä»¶é”™è¯¯', data)
    
    // æ ¹æ®é”™è¯¯ç±»å‹å†³å®šå¤„ç†ç­–ç•¥
    if (data.error.retryable) {
      // å¯é‡è¯•çš„é”™è¯¯
      showRetryDialog(data)
    } else {
      // ä¸å¯é‡è¯•çš„é”™è¯¯ï¼Œè§£é”è¾“å…¥
      if (!data.pluginRequired) {
        unlockInput()
      }
    }
    
    // é€šçŸ¥ç”¨æˆ·
    showErrorMessage(data.error.message)
    
  } catch (error) {
    // é”™è¯¯å¤„ç†å¤±è´¥ï¼Œå¼ºåˆ¶è§£é”
    emergencyUnlock()
  }
}

// âŒ é¿å…ï¼šå¿½ç•¥é”™è¯¯å¤„ç†
const handlePluginError = (data) => {
  console.log('å‡ºé”™äº†') // å¤„ç†ä¸å……åˆ†
}
```

### 4. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

```vue
<template>
  <LiaoWindow>
    <!-- âœ… æ¨èï¼šä½¿ç”¨ v-memo ä¼˜åŒ–å¤§é‡æ¶ˆæ¯æ¸²æŸ“ -->
    <LiaoMessageList>
      <div 
        v-for="message in messages" 
        :key="message.id"
        v-memo="[message.status, message.pluginRequired]"
      >
        <LiaoPluginBubble
          v-if="message.type === 'plugin'"
          :plugin-required="message.pluginRequired"
          @complete="handlePluginComplete"
        />
      </div>
    </LiaoMessageList>
  </LiaoWindow>
</template>

<script setup>
import { computed, shallowRef } from 'vue'

// âœ… æ¨èï¼šä½¿ç”¨ shallowRef ä¼˜åŒ–å¤§å‹çŠ¶æ€å¯¹è±¡
const sessionState = shallowRef({
  sessionMode: 'human',
  isInputLocked: false,
  activePlugin: null,
  lockReason: null
})

// âœ… æ¨èï¼šé˜²æŠ–å¤„ç†é¢‘ç¹çš„çŠ¶æ€å˜åŒ–
const debouncedLockInput = debounce((reason, plugin) => {
  lockInput(reason, plugin)
}, 100)
</script>
```

## ğŸ” è°ƒè¯•å’Œç›‘æ§

### çŠ¶æ€è°ƒè¯•å·¥å…·

```vue
<template>
  <LiaoWindow @input-lock-change="logStateChange">
    <!-- å¼€å‘ç¯å¢ƒä¸‹æ˜¾ç¤ºè°ƒè¯•é¢æ¿ -->
    <div v-if="isDevelopment" class="debug-panel">
      <h3>ğŸ” çŠ¶æ€è°ƒè¯•é¢æ¿</h3>
      <div class="debug-info">
        <div>ä¼šè¯æ¨¡å¼: {{ currentSessionMode }}</div>
        <div>è¾“å…¥é”å®š: {{ isInputLocked ? 'ğŸ”’' : 'ğŸ”“' }}</div>
        <div>é”å®šåŸå› : {{ lockReason || 'æ— ' }}</div>
        <div>æ´»è·ƒæ’ä»¶: {{ activePlugin?.type || 'æ— ' }}</div>
        <div>çŠ¶æ€å˜åŒ–å†å²:</div>
        <ul>
          <li v-for="log in stateLogs" :key="log.id">
            {{ log.timestamp }}: {{ log.message }}
          </li>
        </ul>
      </div>
    </div>

    <LiaoMessageList :messages="messages" />
    <LiaoInputArea />
  </LiaoWindow>
</template>

<script setup>
import { ref } from 'vue'

const isDevelopment = process.env.NODE_ENV === 'development'
const stateLogs = ref([])

const logStateChange = (changeInfo) => {
  stateLogs.value.unshift({
    id: Date.now(),
    timestamp: new Date().toLocaleTimeString(),
    message: `çŠ¶æ€å˜åŒ–: ${JSON.stringify(changeInfo)}`
  })
  
  // é™åˆ¶æ—¥å¿—æ•°é‡
  if (stateLogs.value.length > 50) {
    stateLogs.value = stateLogs.value.slice(0, 50)
  }
}
</script>
```

### æ€§èƒ½ç›‘æ§

```typescript
// çŠ¶æ€å˜åŒ–æ€§èƒ½ç›‘æ§
class SessionStateMonitor {
  private startTime: number = 0
  private changeCount: number = 0
  
  startMonitoring() {
    this.startTime = performance.now()
    this.changeCount = 0
  }
  
  recordStateChange(changeType: string) {
    this.changeCount++
    
    const currentTime = performance.now()
    const duration = currentTime - this.startTime
    
    console.log(`çŠ¶æ€å˜åŒ– [${changeType}]: ç¬¬${this.changeCount}æ¬¡, è€—æ—¶${duration.toFixed(2)}ms`)
    
    // æ£€æµ‹å¼‚å¸¸é¢‘ç¹çš„çŠ¶æ€å˜åŒ–
    if (this.changeCount > 10 && duration < 1000) {
      console.warn('æ£€æµ‹åˆ°å¼‚å¸¸é¢‘ç¹çš„çŠ¶æ€å˜åŒ–ï¼Œå¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜')
    }
  }
  
  getStatistics() {
    const duration = performance.now() - this.startTime
    return {
      totalChanges: this.changeCount,
      totalDuration: duration,
      averageChangeInterval: duration / this.changeCount
    }
  }
}

// ä½¿ç”¨ç›‘æ§å™¨
const monitor = new SessionStateMonitor()
monitor.startMonitoring()

// åœ¨çŠ¶æ€å˜åŒ–æ—¶è®°å½•
const lockInput = (reason, plugin) => {
  monitor.recordStateChange('lock_input')
  // ... é”å®šé€»è¾‘
}
```

## ğŸš¨ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### Q1: è¾“å…¥ä¸€ç›´è¢«é”å®šï¼Œæ— æ³•è§£é™¤æ€ä¹ˆåŠï¼Ÿ

**A**: è¿™é€šå¸¸æ˜¯ç”±äºæ’ä»¶å¼‚å¸¸æˆ–çŠ¶æ€ç®¡ç†é”™è¯¯å¯¼è‡´çš„ã€‚

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// 1. æ£€æŸ¥æ˜¯å¦æœ‰å¿…é¡»å®Œæˆçš„æ’ä»¶æœªæ­£ç¡®å¤„ç†
console.log('å½“å‰æ´»è·ƒæ’ä»¶:', sessionState.activePlugin)

// 2. ä½¿ç”¨ç´§æ€¥è§£é”
windowRef.value?.emergencyUnlock()

// 3. æ£€æŸ¥è‡ªåŠ¨è§£é”æ˜¯å¦æ­£å¸¸å·¥ä½œ
console.log('è‡ªåŠ¨è§£é”è¶…æ—¶æ—¶é—´:', props.autoUnlockTimeout)

// 4. æ‰‹åŠ¨æ¸…ç†çŠ¶æ€ï¼ˆæœ€åæ‰‹æ®µï¼‰
sessionState.isInputLocked = false
sessionState.lockReason = null
sessionState.activePlugin = null
```

### Q2: æ’ä»¶å®Œæˆåè¾“å…¥ä»ç„¶è¢«é”å®šï¼Ÿ

**A**: æ£€æŸ¥æ’ä»¶çš„ `pluginRequired` è®¾ç½®å’Œäº‹ä»¶å¤„ç†ã€‚

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// 1. ç¡®ä¿æ’ä»¶æ­£ç¡®å‘é€å®Œæˆäº‹ä»¶
const handlePluginAction = (action) => {
  if (action.type === 'complete') {
    emit('complete', {
      pluginType: props.pluginType,
      result: action.data
    })
  }
}

// 2. æ£€æŸ¥çˆ¶ç»„ä»¶æ˜¯å¦æ­£ç¡®å¤„ç†å®Œæˆäº‹ä»¶
const handlePluginComplete = (data) => {
  console.log('æ’ä»¶å®Œæˆäº‹ä»¶:', data)
  // ç¡®ä¿è°ƒç”¨è§£é”
  windowRef.value?.unlockInput()
}

// 3. æ£€æŸ¥æ’ä»¶æ˜¯å¦æ ‡è®°ä¸ºå¿…é¡»å®Œæˆ
if (message.pluginRequired === false) {
  // éå¿…é¡»å®Œæˆçš„æ’ä»¶åº”è¯¥ä¸ä¼šé”å®šè¾“å…¥
}
```

### Q3: ä¼šè¯æ¨¡å¼åˆ‡æ¢åçŠ¶æ€å¼‚å¸¸ï¼Ÿ

**A**: æ£€æŸ¥æ¨¡å¼åˆ‡æ¢çš„æ—¶æœºå’ŒçŠ¶æ€æ¸…ç†ã€‚

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// 1. åœ¨æ¨¡å¼åˆ‡æ¢å‰æ¸…ç†çŠ¶æ€
const switchSessionMode = (newMode) => {
  // å…ˆè§£é”è¾“å…¥
  windowRef.value?.unlockInput()
  
  // å†åˆ‡æ¢æ¨¡å¼
  windowRef.value?.setSessionMode(newMode)
}

// 2. ç›‘å¬æ¨¡å¼å˜åŒ–ï¼Œè°ƒæ•´ç›¸å…³é…ç½®
const handleSessionModeChange = ({ oldMode, newMode }) => {
  if (newMode === 'AI') {
    // AIæ¨¡å¼ä¸‹è®¾ç½®è¾ƒçŸ­çš„è¶…æ—¶æ—¶é—´
    autoUnlockTimeout.value = 15000
  } else {
    // äººå·¥æ¨¡å¼ä¸‹è®¾ç½®è¾ƒé•¿çš„è¶…æ—¶æ—¶é—´
    autoUnlockTimeout.value = 60000
  }
}
```

### Q4: æ€§èƒ½é—®é¢˜ï¼ŒçŠ¶æ€å˜åŒ–è¿‡äºé¢‘ç¹ï¼Ÿ

**A**: ä¼˜åŒ–çŠ¶æ€æ›´æ–°é¢‘ç‡å’Œæ¸²æŸ“æ€§èƒ½ã€‚

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// 1. ä½¿ç”¨é˜²æŠ–å¤„ç†é¢‘ç¹çš„çŠ¶æ€å˜åŒ–
import { debounce } from 'lodash-es'

const debouncedLockInput = debounce((reason, plugin) => {
  sessionState.lockInput(reason, plugin)
}, 100)

// 2. ä½¿ç”¨ v-memo ä¼˜åŒ–æ¸²æŸ“
<div v-memo="[sessionState.isInputLocked, sessionState.lockReason]">
  <!-- çŠ¶æ€ç›¸å…³çš„æ¸²æŸ“å†…å®¹ -->
</div>

// 3. é¿å…ä¸å¿…è¦çš„çŠ¶æ€æ›´æ–°
const lockInput = (reason, plugin) => {
  // æ£€æŸ¥çŠ¶æ€æ˜¯å¦çœŸçš„éœ€è¦æ›´æ–°
  if (sessionState.isInputLocked && sessionState.lockReason === reason) {
    return // é¿å…é‡å¤æ›´æ–°
  }
  
  // æ‰§è¡ŒçŠ¶æ€æ›´æ–°
  sessionState.lockInput(reason, plugin)
}
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [LiaoWindow ç»„ä»¶æ–‡æ¡£](./LiaoWindow.md)
- [LiaoInputArea ç»„ä»¶æ–‡æ¡£](./LiaoInputArea.md)
- [LiaoPluginBubble ç»„ä»¶æ–‡æ¡£](./LiaoPluginBubble.md)
- [LiaoMessageList ç»„ä»¶æ–‡æ¡£](./LiaoMessageList.md)

## ğŸ”„ æ›´æ–°æ—¥å¿—

### v2.7.5 (2025-06-25)
- âœ… å®Œå–„ä¼šè¯çŠ¶æ€ç®¡ç†ä½¿ç”¨è¯´æ˜
- âœ… æ–°å¢è¯¦ç»†çš„APIæ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹
- âœ… å¢åŠ æœ€ä½³å®è·µæŒ‡å¯¼
- âœ… å®Œå–„é”™è¯¯å¤„ç†å’Œè°ƒè¯•æŒ‡å—

### v2.7.0 (2025-06-16)
- âœ… åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ… å®ç°å…¨å±€çŠ¶æ€ç®¡ç†
- âœ… æ”¯æŒè¾“å…¥é”å®šæ§åˆ¶
- âœ… æ”¯æŒæ’ä»¶å¿…é¡»å®ŒæˆçŠ¶æ€
- âœ… æ·»åŠ è‡ªåŠ¨è§£é”æœºåˆ¶

---

ğŸ“„ **æŠ€æœ¯æ”¯æŒ**: å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·å‚è€ƒ [å¸¸è§é—®é¢˜è§£ç­”](../FAQ.md) æˆ–æäº¤ [Issue](https://github.com/html1602/LiaoKit/issues) 